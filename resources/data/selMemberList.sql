SELECT
    MEM.MID,
	MEM.NICKNAME,
	MI.PUB_NAME,
	MI.PUB_RESIDENCE,
	MI.PUB_GENDER,
	MEM.FAMILYNAME||' '||MEM.NAME AS NAME,
	(SELECT REGIONNM FROM MST_PREFECTURES WHERE REGIONCD = MEM.RESIDENCE_REGION) AS RESIDENCEREGION,
	(SELECT CASE MEM.GENDER WHEN '1' THEN '男性' WHEN '2' THEN '女性' ELSE NULL END AS GENDER FROM MEMBERS WHERE MID = MEM.MID) AS GENDER,
	COALESCE(MEM.ABOUTME,'') AS ABOUTME,
	CASE PHOTO.MAINPICNO WHEN '1' THEN PHOTO.PIC1 WHEN '2' THEN PHOTO.PIC2 WHEN '3' THEN PHOTO.PIC3 END AS PHOTO,
	CASE WHEN A.LOGINDATE < 5 THEN '5分以内'
	WHEN A.LOGINDATE < 55 THEN (TRUNC(A.LOGINDATE/5 + .9, 0)*5)||'分以内'
	WHEN A.LOGINDATE < 60*23 THEN CEIL(A.LOGINDATE/60)||'時間以内'
	WHEN A.LOGINDATE < 60*24 THEN '1日以内'
	WHEN A.LOGINDATE < 60*72 THEN TRUNC(A.LOGINDATE/60/24)+1||'日以内'
	ELSE '3'||'日以上'
	END AS LOGINDATE
FROM
    MEMBERS MEM
    LEFT JOIN MEMBERPHOTO_INFO PHOTO ON  MEM.MID = PHOTO.MID
    LEFT JOIN (SELECT
				MID,
				CASE TO_NUMBER(TO_CHAR(CURRENT_TIMESTAMP - LASTACCESSDATE,'DDD'),'99999') WHEN 0 THEN        TO_NUMBER(TO_CHAR(CURRENT_TIMESTAMP - LASTACCESSDATE,'HH24'),'9999')*60+TO_NUMBER(TO_CHAR(CURRENT_TIMESTAMP - LASTACCESSDATE,'MI'),'99') ELSE TO_NUMBER(TO_CHAR(CURRENT_TIMESTAMP - LASTACCESSDATE,'DDD'),'99999')*60*24 END AS LOGINDATE
				FROM
				MEMBERS) A ON MEM.MID = A.MID,
    MEMBERITEM_INFO MI
WHERE
    MI.MID = MEM.MID
AND
    MEM.STATUS = '1'
AND
    MEM.MEMBERTYPE = '0'
AND
	MEM.MID != /*mid*/
/*IF nickname != null && nickname != ""*/
AND
	MEM.NICKNAME like '%' || /*nickname*/ || '%' ESCAPE '#'
/*END*/
/*IF aboutme != null && aboutme != ""*/
AND
	MEM.ABOUTME like '%' || /*aboutme*/ || '%' ESCAPE '#'
/*END*/
ORDER BY
MEM.MID